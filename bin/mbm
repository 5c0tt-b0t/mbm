#!/bin/bash

VERSION="0.2"

PROGRAM="${0##*/}"

mkdir -p $HOME/.bookmarks
mkdir -p $HOME/.bookmarks/cache
touch $HOME/.bookmarks/list

cachefolder=$HOME/.bookmarks/cache
list=$HOME/.bookmarks/list

add(){
  overwrite=lulz
  url=$1

  count=$(grep "$url |" "$list" | wc -l)
  if [ $count -gt 0 ]
    then
    read -p "$url already exists, overwrite? y/N " overwrite
  fi

  case $overwrite in
    y|Y)
      echo "**OVERWRITING**"
      over=y
    ;;
    lulz)
    ;;
    n|N|*)
      exit 0
    ;;
  esac

  if [ "$over" = "y" ]
  then
    grep -v "^${url} |" $list > .temp ; mv .temp $list
  fi

  urlforfile=$(echo $url | sed 's/[/?=!:_]/-/g')
  cachefile=$cachefolder/${urlforfile}.html
  curl -s $url > $cachefile
  title=$(sed -rn 's/<title>(.*)<\/title>/\1/p' $cachefile)
  read -p "Description (default: $title): " description
  [ -z $description ] && description=$title
  echo "$url | $description | $cachefile" >> $list
}

search(){
  terms=$@
  termsforgrep=$(echo $terms | sed 's/ /\\|/g')
  for i in $(grep -li "$termsforgrep" $cachefolder/*) ; do
    grep $i $list
  done
}

stats(){
  echo
  echo $list holds `wc -l $list | awk '{print $1}'` bookmarks
  echo
}

list(){
  echo
  cat $list \
    | awk '
    BEGIN { FS = "|" }
    {
      printf "  \033[36m%s\033[0m\n", $1
      printf "  \033[33m%s\033[0m\n", $2
      printf "  \033[90m%s\033[0m\n\n", $3
    }'
  echo
}

usage() {
  cat <<EOF

  Usage: $PROGRAM [OPTION] [cmd]

  Commands:

    $ $PROGRAM add <url>
        # add a bookmark with the given url
        
    $ $PROGRAM search <query>
	# search the bookmarks via full-text <query>

    $ $PROGRAM list
        # list all bookmarks

  Options:

     -V, --version   display version information and exit
     -h, --help      display this help information and exit

EOF
}

case "$1" in
  version|-V|--version) echo $PROGRAM $VERSION ;;
  help|-h|--help) usage ;;
  add|insert) add $2 ;;
  list|show|ls) list ;;
  stats) stats ;;
  grep|search) search ${*:2} ;;
  *) usage ;;
esac

exit 0